<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evolution Guide ç­›é€‰å™¨æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        
        .filter-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .filter-group label {
            font-weight: bold;
            color: #555;
        }
        
        .filter-group select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            min-width: 150px;
        }
        
        .results-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        
        .btn:hover {
            background: #0056b3;
        }
        
        .success {
            color: #28a745;
            font-weight: bold;
        }
        
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        
        .warning {
            color: #ffc107;
            font-weight: bold;
        }
        
        .unit-item {
            background: white;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }
        
        .unit-name {
            font-weight: bold;
            color: #333;
        }
        
        .unit-details {
            color: #666;
            font-size: 11px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Evolution Guide ç­›é€‰å™¨æµ‹è¯•</h1>
        
        <div class="test-section">
            <h3>ğŸ¯ ç­›é€‰å™¨æ§åˆ¶</h3>
            <div class="filter-controls">
                <div class="filter-group">
                    <label for="rarityFilter">ç¨€æœ‰åº¦ç­›é€‰:</label>
                    <select id="rarityFilter">
                        <option value="">All Rarity</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="elementFilter">å…ƒç´ ç­›é€‰:</label>
                    <select id="elementFilter">
                        <option value="">All Element</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="unitSearch">æœç´¢:</label>
                    <input type="text" id="unitSearch" placeholder="è¾“å…¥å•ä½åç§°..." style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px;">
                </div>
            </div>
            
            <button class="btn" onclick="testFilters()">ğŸ§ª æµ‹è¯•ç­›é€‰å™¨</button>
            <button class="btn" onclick="resetFilters()">ğŸ”„ é‡ç½®ç­›é€‰å™¨</button>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“Š ç­›é€‰ç»“æœ</h3>
            <div id="filterResults" class="results-display">
                ç‚¹å‡»"æµ‹è¯•ç­›é€‰å™¨"æŒ‰é’®å¼€å§‹æµ‹è¯•...
            </div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ” è°ƒè¯•ä¿¡æ¯</h3>
            <div id="debugInfo" class="results-display">
                è°ƒè¯•ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º...
            </div>
        </div>
    </div>

    <script type="module">
        // æ¨¡æ‹Ÿæ•°æ® - ä¸evolution.jsä¸­ä½¿ç”¨çš„ç›¸åŒ
        const mockUnitsData = [
            {
                id: "goku_ultra_instinct",
                name: "Goku (Ultra Instinct)",
                rarity: "Mythic",
                element: "Energy",
                evolution: "Ultra Instinct",
                obtainment: "Dragon Ball Banner (0.1% drop rate)"
            },
            {
                id: "saitama",
                name: "Saitama",
                rarity: "Mythic",
                element: "Physical",
                evolution: "One Punch Man",
                obtainment: "One Punch Man Banner (0.1% drop rate)"
            },
            {
                id: "goku_base",
                name: "Goku",
                rarity: "Legendary",
                element: "Energy",
                evolution: "Base Form",
                obtainment: "Dragon Ball Banner (2% drop rate)"
            },
            {
                id: "naruto_base",
                name: "Naruto",
                rarity: "Legendary",
                element: "Wind",
                evolution: "Six Paths Sage Mode",
                obtainment: "Naruto Banner (2% drop rate)"
            },
            {
                id: "tanjiro",
                name: "Tanjiro",
                rarity: "Epic",
                element: "Water",
                evolution: "Sun Breathing",
                obtainment: "Demon Slayer Banner (5% drop rate)"
            },
            {
                id: "ichigo_base",
                name: "Ichigo",
                rarity: "Epic",
                element: "Soul",
                evolution: "Bankai",
                obtainment: "Bleach Banner (5% drop rate)"
            }
        ];

        const mockEvolutionData = {
            "goku": {
                unitId: "goku",
                evolutions: [
                    { tier: 1, name: "Goku", requirements: { level: 1, materials: [], cost: 1200 } },
                    { tier: 2, name: "Super Saiyan Goku", requirements: { level: 40, materials: ["Saiyan Blood x4"], cost: 2500 } },
                    { tier: 3, name: "Super Saiyan Blue Goku", requirements: { level: 60, materials: ["Divine Ki x3"], cost: 4500 } }
                ]
            },
            "tanjiro": {
                unitId: "tanjiro",
                evolutions: [
                    { tier: 1, name: "Tanjiro", requirements: { level: 1, materials: [], cost: 800 } },
                    { tier: 2, name: "Tanjiro (Water Breathing Master)", requirements: { level: 35, materials: ["Water Essence x3"], cost: 1500 } },
                    { tier: 3, name: "Tanjiro (Sun Breathing)", requirements: { level: 55, materials: ["Sun Stone x2"], cost: 2200 } }
                ]
            }
        };

        // æ¨¡æ‹ŸRARITIESå’ŒELEMENTSå¸¸é‡
        const RARITIES = [
            { value: "Common", label: "Common", canEvolve: false },
            { value: "Uncommon", label: "Uncommon", canEvolve: false },
            { value: "Rare", label: "Rare", canEvolve: true },
            { value: "Epic", label: "Epic", canEvolve: true },
            { value: "Legendary", label: "Legendary", canEvolve: true },
            { value: "Mythic", label: "Mythic", canEvolve: true }
        ];

        const ELEMENTS = [
            { value: "Fire", label: "Fire" },
            { value: "Water", label: "Water" },
            { value: "Wind", label: "Wind" },
            { value: "Lightning", label: "Lightning" },
            { value: "Dark", label: "Dark" },
            { value: "Light", label: "Light" },
            { value: "Physical", label: "Physical" },
            { value: "Energy", label: "Energy" },
            { value: "Soul", label: "Soul" }
        ];

        // åˆå§‹åŒ–ç­›é€‰å™¨
        function initializeFilters() {
            const rarityFilter = document.getElementById('rarityFilter');
            const elementFilter = document.getElementById('elementFilter');
            
            // å¡«å……ç¨€æœ‰åº¦ç­›é€‰å™¨
            RARITIES.forEach(rarity => {
                if (rarity.canEvolve) {
                    const count = getRarityCount(rarity.value);
                    const option = document.createElement('option');
                    option.value = rarity.value;
                    option.textContent = `${rarity.label} (${count})`;
                    rarityFilter.appendChild(option);
                }
            });
            
            // å¡«å……å…ƒç´ ç­›é€‰å™¨
            ELEMENTS.forEach(element => {
                const count = getElementCount(element.value);
                const option = document.createElement('option');
                option.value = element.value;
                option.textContent = `${element.label} (${count})`;
                elementFilter.appendChild(option);
            });
            
            // ç»‘å®šäº‹ä»¶
            rarityFilter.addEventListener('change', updateResults);
            elementFilter.addEventListener('change', updateResults);
            document.getElementById('unitSearch').addEventListener('input', debounce(updateResults, 300));
        }

        // è·å–ç¨€æœ‰åº¦æ•°é‡
        function getRarityCount(rarityValue) {
            if (!rarityValue) return 0;
            return mockUnitsData.filter(unit => unit.rarity === rarityValue).length;
        }

        // è·å–å…ƒç´ æ•°é‡
        function getElementCount(elementValue) {
            if (!elementValue) return 0;
            return mockUnitsData.filter(unit => unit.element === elementValue).length;
        }

        // é˜²æŠ–å‡½æ•°
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // æ›´æ–°ç»“æœ
        function updateResults() {
            const rarityFilter = document.getElementById('rarityFilter').value;
            const elementFilter = document.getElementById('elementFilter').value;
            const searchTerm = document.getElementById('unitSearch').value;
            
            // ä½¿ç”¨ä¸evolution.jsç›¸åŒçš„ç­›é€‰é€»è¾‘
            const filteredUnits = filterEvolutionUnits(mockUnitsData, rarityFilter, elementFilter, searchTerm);
            
            displayResults(filteredUnits, rarityFilter, elementFilter, searchTerm);
            updateDebugInfo(filteredUnits, rarityFilter, elementFilter, searchTerm);
        }

        // ç­›é€‰é€»è¾‘ - ä¸evolution.jsä¸­çš„ç›¸åŒ
        function filterEvolutionUnits(units, selectedRarity, selectedElement, searchTerm = '') {
            return units.filter(unit => {
                // 1. æ£€æŸ¥æ˜¯å¦å¯è¿›åŒ–
                let canEvolve = false;
                
                // æ–¹æ³•1: æ£€æŸ¥ç¨€æœ‰åº¦
                if (['Rare', 'Epic', 'Legendary', 'Mythic'].includes(unit.rarity)) {
                    canEvolve = true;
                }
                
                // æ–¹æ³•2: æ£€æŸ¥æ˜¯å¦æœ‰evolutionå±æ€§
                if (unit.evolution || unit.evolutionName) {
                    canEvolve = true;
                }
                
                // æ–¹æ³•3: æ£€æŸ¥æ˜¯å¦æœ‰canEvolveå±æ€§
                if (unit.canEvolve) {
                    canEvolve = true;
                }
                
                // æ–¹æ³•4: æ£€æŸ¥æ˜¯å¦åœ¨evolutionDataä¸­å­˜åœ¨
                const possibleIds = [
                    unit.id,
                    unit.id.replace(/_base$/, ''),
                    unit.id.replace(/_evolved$/, ''),
                    unit.name.toLowerCase().replace(/\s+/g, ''),
                    unit.name.toLowerCase().replace(/\s+/g, '').replace(/\([^)]*\)/g, '')
                ];
                
                if (possibleIds.some(id => mockEvolutionData[id])) {
                    canEvolve = true;
                }
                
                if (!canEvolve) {
                    return false;
                }
                
                // 2. ç¨€æœ‰åº¦åŒ¹é…
                if (selectedRarity && unit.rarity !== selectedRarity) {
                    return false;
                }
                
                // 3. å…ƒç´ åŒ¹é…
                if (selectedElement && unit.element !== selectedElement) {
                    return false;
                }
                
                // 4. æœç´¢è¯åŒ¹é…
                if (searchTerm) {
                    const searchLower = searchTerm.toLowerCase();
                    const nameMatch = unit.name.toLowerCase().includes(searchLower);
                    const evolutionMatch = (unit.evolution && unit.evolution.toLowerCase().includes(searchLower));
                    const obtainMatch = (unit.obtainment && unit.obtainment.toLowerCase().includes(searchLower));
                    
                    if (!nameMatch && !evolutionMatch && !obtainMatch) {
                        return false;
                    }
                }
                
                return true;
            });
        }

        // æ˜¾ç¤ºç»“æœ
        function displayResults(units, rarityFilter, elementFilter, searchTerm) {
            const resultsDiv = document.getElementById('filterResults');
            
            if (units.length === 0) {
                resultsDiv.innerHTML = `
                    <div class="warning">
                        <h4>âŒ æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„å•ä½</h4>
                        <p>ç­›é€‰æ¡ä»¶: ç¨€æœ‰åº¦=${rarityFilter || 'All'}, å…ƒç´ =${elementFilter || 'All'}, æœç´¢=${searchTerm || 'None'}</p>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="success">
                    <h4>âœ… æ‰¾åˆ° ${units.length} ä¸ªåŒ¹é…å•ä½</h4>
                    <p>ç­›é€‰æ¡ä»¶: ç¨€æœ‰åº¦=${rarityFilter || 'All'}, å…ƒç´ =${elementFilter || 'All'}, æœç´¢=${searchTerm || 'None'}</p>
                </div>
                <hr>
            `;
            
            units.forEach(unit => {
                html += `
                    <div class="unit-item">
                        <div class="unit-name">${unit.name}</div>
                        <div class="unit-details">
                            ç¨€æœ‰åº¦: ${unit.rarity} | å…ƒç´ : ${unit.element} | è¿›åŒ–: ${unit.evolution}
                        </div>
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
        }

        // æ›´æ–°è°ƒè¯•ä¿¡æ¯
        function updateDebugInfo(units, rarityFilter, elementFilter, searchTerm) {
            const debugDiv = document.getElementById('debugInfo');
            
            let html = `
                <h4>ğŸ” è°ƒè¯•ä¿¡æ¯</h4>
                <p><strong>ç­›é€‰æ¡ä»¶:</strong></p>
                <ul>
                    <li>ç¨€æœ‰åº¦: ${rarityFilter || 'All Rarity'}</li>
                    <li>å…ƒç´ : ${elementFilter || 'All Element'}</li>
                    <li>æœç´¢: ${searchTerm || 'None'}</li>
                </ul>
                
                <p><strong>æ•°æ®ç»Ÿè®¡:</strong></p>
                <ul>
                    <li>æ€»å•ä½æ•°: ${mockUnitsData.length}</li>
                    <li>å¯è¿›åŒ–å•ä½æ•°: ${mockUnitsData.filter(u => ['Rare', 'Epic', 'Legendary', 'Mythic'].includes(u.rarity)).length}</li>
                    <li>ç­›é€‰åå•ä½æ•°: ${units.length}</li>
                </ul>
                
                <p><strong>ç¨€æœ‰åº¦åˆ†å¸ƒ:</strong></p>
                <ul>
                    ${Object.entries(getRarityDistribution()).map(([rarity, count]) => `<li>${rarity}: ${count}</li>`).join('')}
                </ul>
                
                <p><strong>å…ƒç´ åˆ†å¸ƒ:</strong></p>
                <ul>
                    ${Object.entries(getElementDistribution()).map(([element, count]) => `<li>${element}: ${count}</li>`).join('')}
                </ul>
            `;
            
            debugDiv.innerHTML = html;
        }

        // è·å–ç¨€æœ‰åº¦åˆ†å¸ƒ
        function getRarityDistribution() {
            const distribution = {};
            mockUnitsData.forEach(unit => {
                distribution[unit.rarity] = (distribution[unit.rarity] || 0) + 1;
            });
            return distribution;
        }

        // è·å–å…ƒç´ åˆ†å¸ƒ
        function getElementDistribution() {
            const distribution = {};
            mockUnitsData.forEach(unit => {
                distribution[unit.element] = (distribution[unit.element] || 0) + 1;
            });
            return distribution;
        }

        // æµ‹è¯•ç­›é€‰å™¨
        window.testFilters = function() {
            console.log('ğŸ§ª å¼€å§‹æµ‹è¯•ç­›é€‰å™¨...');
            updateResults();
        };

        // é‡ç½®ç­›é€‰å™¨
        window.resetFilters = function() {
            document.getElementById('rarityFilter').value = '';
            document.getElementById('elementFilter').value = '';
            document.getElementById('unitSearch').value = '';
            updateResults();
        };

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ Evolution Guide ç­›é€‰å™¨æµ‹è¯•é¡µé¢å·²åŠ è½½');
            initializeFilters();
            updateResults();
        });
    </script>
</body>
</html>
