<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensive Evolution Calculator Test</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components/forms.css">
    <link rel="stylesheet" href="css/pages/evolution.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #0f0f23;
            color: #ffffff;
        }
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            background: #1a1a2e;
            padding: 20px;
            border-radius: 8px;
        }
        .test-section { 
            margin: 20px 0; 
            padding: 15px; 
            border: 1px solid #333; 
            border-radius: 5px; 
        }
        .test-title {
            color: #6c5ce7;
            margin-bottom: 15px;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .test-card {
            background: #2a2a3e;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #444;
        }
        .test-card h4 {
            color: #6c5ce7;
            margin-bottom: 10px;
        }
        .test-result {
            padding: 8px;
            margin: 5px 0;
            border-radius: 3px;
            font-size: 0.9rem;
        }
        .test-pass {
            background: rgba(40, 167, 69, 0.2);
            border: 1px solid #28a745;
            color: #28a745;
        }
        .test-fail {
            background: rgba(220, 53, 69, 0.2);
            border: 1px solid #dc3545;
            color: #dc3545;
        }
        .test-info {
            background: rgba(108, 92, 231, 0.2);
            border: 1px solid #6c5ce7;
            color: #6c5ce7;
        }
        .filter-section {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .filter-group label {
            font-weight: bold;
            color: #ddd;
        }
        .test-button {
            background: #6c5ce7;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #5a4fd8;
        }
        .run-all-btn {
            background: #28a745;
            font-size: 1.1rem;
            padding: 15px 30px;
        }
        .run-all-btn:hover {
            background: #218838;
        }
        .results-summary {
            background: #2a2a3e;
            padding: 20px;
            border-radius: 5px;
            margin-top: 20px;
        }
        .summary-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }
        .stat-item {
            text-align: center;
            padding: 10px;
            background: rgba(108, 92, 231, 0.1);
            border-radius: 5px;
            min-width: 100px;
        }
        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #6c5ce7;
        }
        .stat-label {
            font-size: 0.8rem;
            color: #aaa;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 Comprehensive Evolution Calculator Test</h1>
        
        <div class="test-section">
            <h2 class="test-title">🎯 关键组合测试</h2>
            <p>测试必须通过的关键稀有度+元素组合</p>
            
            <div class="test-grid">
                <div class="test-card">
                    <h4>Vanguard + Unknown</h4>
                    <p>应显示: Song Jinwu and Igros</p>
                    <div id="test1-result" class="test-result test-info">等待测试...</div>
                    <button class="test-button" onclick="runTest1()">运行测试</button>
                </div>
                
                <div class="test-card">
                    <h4>Secret + Cosmic</h4>
                    <p>应显示: Yehowach (Almighty)</p>
                    <div id="test2-result" class="test-result test-info">等待测试...</div>
                    <button class="test-button" onclick="runTest2()">运行测试</button>
                </div>
                
                <div class="test-card">
                    <h4>Secret + Blood</h4>
                    <p>应显示: Alocard (Vampire King)</p>
                    <div id="test3-result" class="test-result test-info">等待测试...</div>
                    <button class="test-button" onclick="runTest3()">运行测试</button>
                </div>
                
                <div class="test-card">
                    <h4>Mythic + Holy</h4>
                    <p>应显示: Saber (King of Knights)</p>
                    <div id="test4-result" class="test-result test-info">等待测试...</div>
                    <button class="test-button" onclick="runTest4()">运行测试</button>
                </div>
                
                <div class="test-card">
                    <h4>Exclusive + Spark</h4>
                    <p>应显示: Luce (Hacker), Dawntay (Jackpot)</p>
                    <div id="test5-result" class="test-result test-info">等待测试...</div>
                    <button class="test-button" onclick="runTest5()">运行测试</button>
                </div>
                
                <div class="test-card">
                    <h4>Legendary + 任意元素</h4>
                    <p>应显示: No units available</p>
                    <div id="test6-result" class="test-result test-info">等待测试...</div>
                    <button class="test-button" onclick="runTest6()">运行测试</button>
                </div>
            </div>
            
            <button class="test-button run-all-btn" onclick="runAllTests()">运行所有测试</button>
        </div>
        
        <div class="test-section">
            <h2 class="test-title">🔍 功能验证测试</h2>
            
            <div class="filter-section">
                <div class="filter-group">
                    <label for="testRarityFilter">Rarity:</label>
                    <select id="testRarityFilter" class="filter-select">
                        <option value="">All Rarity</option>
                        <option value="Vanguard">Vanguard</option>
                        <option value="Secret">Secret</option>
                        <option value="Exclusive">Exclusive</option>
                        <option value="Mythic">Mythic</option>
                        <option value="Legendary">Legendary</option>
                        <option value="Epic">Epic</option>
                        <option value="Rare">Rare</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="testElementFilter">Element:</label>
                    <select id="testElementFilter" class="filter-select">
                        <option value="">All Element</option>
                        <option value="Unknown">Unknown</option>
                        <option value="Cosmic">Cosmic</option>
                        <option value="Holy">Holy</option>
                        <option value="Fire">Fire</option>
                        <option value="Water">Water</option>
                        <option value="Nature">Nature</option>
                        <option value="Life">Life</option>
                        <option value="Spirit">Spirit</option>
                        <option value="Spark">Spark</option>
                        <option value="Passion">Passion</option>
                        <option value="Blood">Blood</option>
                        <option value="Shadow">Shadow</option>
                        <option value="Curse">Curse</option>
                        <option value="Earth">Earth</option>
                        <option value="Lightning">Lightning</option>
                        <option value="Dark">Dark</option>
                        <option value="Physical">Physical</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="testSearchInput">Search:</label>
                    <input type="text" id="testSearchInput" class="search-input" placeholder="Search units...">
                </div>
            </div>
            
            <div id="testResults" class="test-results"></div>
            <div id="unitCountDisplay" class="unit-count-display" style="display: none;"></div>
            
            <button class="test-button" onclick="testRarityOptions()">测试稀有度选项</button>
            <button class="test-button" onclick="testElementOptions()">测试元素选项</button>
            <button class="test-button" onclick="testAllRarityElement()">测试All Rarity + All Element</button>
            <button class="test-button" onclick="clearTestFilters()">清除筛选</button>
        </div>
        
        <div class="results-summary">
            <h3>📊 测试结果总结</h3>
            <div class="summary-stats">
                <div class="stat-item">
                    <div class="stat-number" id="totalTests">0</div>
                    <div class="stat-label">总测试</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="passedTests">0</div>
                    <div class="stat-label">通过</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="failedTests">0</div>
                    <div class="stat-label">失败</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="successRate">0%</div>
                    <div class="stat-label">成功率</div>
                </div>
            </div>
            <div id="testLog"></div>
        </div>
    </div>

    <script type="module">
        import { EVOLUTION_UNITS, evolutionUtils } from './js/config/evolutionUnits.js';
        import { RARITIES, ELEMENTS, dataUtils } from './js/config/constants.js';

        // 测试状态管理
        let testResults = {
            total: 0,
            passed: 0,
            failed: 0,
            tests: []
        };

        // 筛选逻辑函数（复制自UnitSelector）
        function filterEvolutionUnits(units, selectedRarity, selectedElement, searchTerm = '') {
            return units.filter(unit => {
                // 1. 只显示可进化的稀有度
                const canEvolveRarities = ['Vanguard', 'Secret', 'Exclusive', 'Mythic'];
                if (!canEvolveRarities.includes(unit.rarity)) {
                    return false;
                }
                
                // 2. 确保单位可以进化
                if (unit.canEvolve !== true) {
                    return false;
                }
                
                // 3. 稀有度匹配
                if (selectedRarity && selectedRarity !== 'All Rarity' && unit.rarity !== selectedRarity) {
                    return false;
                }
                
                // 4. 元素匹配
                if (selectedElement && selectedElement !== 'All Element' && unit.element !== selectedElement) {
                    return false;
                }
                
                // 5. 搜索词匹配
                if (searchTerm) {
                    const searchLower = searchTerm.toLowerCase();
                    const nameMatch = unit.name.toLowerCase().includes(searchLower);
                    const evolutionMatch = unit.evolutionName.toLowerCase().includes(searchLower);
                    
                    if (!nameMatch && !evolutionMatch) {
                        return false;
                    }
                }
                
                return true;
            });
        }

        // 更新测试统计
        function updateTestStats() {
            document.getElementById('totalTests').textContent = testResults.total;
            document.getElementById('passedTests').textContent = testResults.passed;
            document.getElementById('failedTests').textContent = testResults.failed;
            document.getElementById('successRate').textContent = 
                testResults.total > 0 ? `${Math.round((testResults.passed / testResults.total) * 100)}%` : '0%';
        }

        // 添加测试日志
        function addTestLog(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const logEntry = document.createElement('div');
            logEntry.style.padding = '5px';
            logEntry.style.margin = '2px 0';
            logEntry.style.fontSize = '0.9rem';
            
            if (type === 'success') {
                logEntry.style.color = '#28a745';
            } else if (type === 'error') {
                logEntry.style.color = '#dc3545';
            } else {
                logEntry.style.color = '#6c5ce7';
            }
            
            logEntry.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // 运行单个测试
        function runSingleTest(testName, rarity, element, expectedUnits, testId) {
            const filteredUnits = filterEvolutionUnits(EVOLUTION_UNITS, rarity, element, '');
            const resultDiv = document.getElementById(testId);
            
            let passed = false;
            let message = '';
            
            if (expectedUnits === 'none') {
                // 期望没有单位
                passed = filteredUnits.length === 0;
                message = passed ? 
                    `✅ 正确：没有找到单位（期望：无单位）` : 
                    `❌ 错误：找到 ${filteredUnits.length} 个单位（期望：无单位）`;
            } else {
                // 期望特定单位
                const expectedUnitNames = Array.isArray(expectedUnits) ? expectedUnits : [expectedUnits];
                const foundUnitNames = filteredUnits.map(unit => unit.name);
                
                passed = expectedUnitNames.every(expected => 
                    foundUnitNames.some(found => found.includes(expected))
                );
                
                message = passed ? 
                    `✅ 正确：找到期望的单位 ${expectedUnitNames.join(', ')}` : 
                    `❌ 错误：期望 ${expectedUnitNames.join(', ')}，实际找到 ${foundUnitNames.join(', ')}`;
            }
            
            resultDiv.className = `test-result ${passed ? 'test-pass' : 'test-fail'}`;
            resultDiv.textContent = message;
            
            // 更新统计
            testResults.total++;
            if (passed) {
                testResults.passed++;
                addTestLog(`✅ ${testName}: 通过`, 'success');
            } else {
                testResults.failed++;
                addTestLog(`❌ ${testName}: 失败`, 'error');
            }
            updateTestStats();
            
            return passed;
        }

        // 测试1: Vanguard + Unknown
        window.runTest1 = function() {
            runSingleTest(
                'Vanguard + Unknown',
                'Vanguard',
                'Unknown',
                'Song Jinwu and Igros',
                'test1-result'
            );
        };

        // 测试2: Secret + Cosmic
        window.runTest2 = function() {
            runSingleTest(
                'Secret + Cosmic',
                'Secret',
                'Cosmic',
                'Yehowach (Almighty)',
                'test2-result'
            );
        };

        // 测试3: Secret + Blood
        window.runTest3 = function() {
            runSingleTest(
                'Secret + Blood',
                'Secret',
                'Blood',
                'Alocard (Vampire King)',
                'test3-result'
            );
        };

        // 测试4: Mythic + Holy
        window.runTest4 = function() {
            runSingleTest(
                'Mythic + Holy',
                'Mythic',
                'Holy',
                'Saber (King of Knights)',
                'test4-result'
            );
        };

        // 测试5: Exclusive + Spark
        window.runTest5 = function() {
            runSingleTest(
                'Exclusive + Spark',
                'Exclusive',
                'Spark',
                ['Luce (Hacker)', 'Dawntay (Jackpot)'],
                'test5-result'
            );
        };

        // 测试6: Legendary + 任意元素
        window.runTest6 = function() {
            runSingleTest(
                'Legendary + Fire',
                'Legendary',
                'Fire',
                'none',
                'test6-result'
            );
        };

        // 运行所有测试
        window.runAllTests = function() {
            addTestLog('🚀 开始运行所有测试...', 'info');
            
            // 重置统计
            testResults = { total: 0, passed: 0, failed: 0, tests: [] };
            updateTestStats();
            
            // 运行所有测试
            runTest1();
            runTest2();
            runTest3();
            runTest4();
            runTest5();
            runTest6();
            
            addTestLog(`📊 所有测试完成！通过: ${testResults.passed}/${testResults.total}`, 
                testResults.failed === 0 ? 'success' : 'error');
        };

        // 测试稀有度选项
        window.testRarityOptions = function() {
            addTestLog('🔍 测试稀有度选项...', 'info');
            
            const raritySelect = document.getElementById('testRarityFilter');
            const options = Array.from(raritySelect.options).slice(1);
            const expectedRarities = ['Vanguard', 'Secret', 'Exclusive', 'Mythic', 'Legendary', 'Epic', 'Rare'];
            
            const isCorrect = expectedRarities.every((rarity, index) => options[index]?.value === rarity);
            
            if (isCorrect) {
                addTestLog('✅ 稀有度选项正确', 'success');
            } else {
                addTestLog('❌ 稀有度选项错误', 'error');
            }
        };

        // 测试元素选项
        window.testElementOptions = function() {
            addTestLog('🔍 测试元素选项...', 'info');
            
            const elementSelect = document.getElementById('testElementFilter');
            const options = Array.from(elementSelect.options).slice(1);
            
            // 检查是否包含所有必需的元素
            const requiredElements = ['Unknown', 'Cosmic', 'Holy', 'Fire', 'Water', 'Nature', 'Life', 'Spirit', 'Spark', 'Passion', 'Blood', 'Shadow'];
            const foundElements = options.map(option => option.value);
            
            const missingElements = requiredElements.filter(element => !foundElements.includes(element));
            
            if (missingElements.length === 0) {
                addTestLog('✅ 元素选项完整', 'success');
            } else {
                addTestLog(`❌ 缺少元素: ${missingElements.join(', ')}`, 'error');
            }
        };

        // 测试All Rarity + All Element
        window.testAllRarityElement = function() {
            addTestLog('🔍 测试All Rarity + All Element...', 'info');
            
            const filteredUnits = filterEvolutionUnits(EVOLUTION_UNITS, '', '', '');
            const countDisplay = document.getElementById('unitCountDisplay');
            
            countDisplay.style.display = 'block';
            countDisplay.innerHTML = `
                <div class="count-info">
                    <span class="count-text">Found ${filteredUnits.length} units matching your criteria</span>
                    <span class="count-detail">(${EVOLUTION_UNITS.length} total units available)</span>
                </div>
            `;
            
            addTestLog(`✅ All Rarity + All Element: 找到 ${filteredUnits.length} 个单位`, 'success');
        };

        // 清除测试筛选
        window.clearTestFilters = function() {
            document.getElementById('testRarityFilter').value = '';
            document.getElementById('testElementFilter').value = '';
            document.getElementById('testSearchInput').value = '';
            document.getElementById('unitCountDisplay').style.display = 'none';
            addTestLog('🧹 已清除所有筛选条件', 'info');
        };

        // 页面加载时初始化
        window.addEventListener('load', function() {
            addTestLog('🚀 全面测试页面已加载', 'info');
            addTestLog(`📊 加载了 ${EVOLUTION_UNITS.length} 个进化单位`, 'info');
            updateTestStats();
        });
    </script>
</body>
</html> 