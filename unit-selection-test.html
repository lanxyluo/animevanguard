<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unit Selection State Test</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components/forms.css">
    <link rel="stylesheet" href="css/pages/evolution.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #0f0f23;
            color: #ffffff;
        }
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            background: #1a1a2e;
            padding: 20px;
            border-radius: 8px;
        }
        .test-section { 
            margin: 20px 0; 
            padding: 15px; 
            border: 1px solid #333; 
            border-radius: 5px; 
        }
        .test-title {
            color: #6c5ce7;
            margin-bottom: 15px;
        }
        .state-display {
            background: #2a2a3e;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #444;
        }
        .state-item {
            margin: 5px 0;
            padding: 5px;
            background: rgba(108, 92, 231, 0.1);
            border-radius: 3px;
        }
        .test-button {
            background: #6c5ce7;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #5a4fd8;
        }
        .log-section {
            background: #2a2a3e;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        .log-entry {
            margin: 2px 0;
            padding: 2px;
            font-family: monospace;
            font-size: 0.9rem;
        }
        .log-info { color: #6c5ce7; }
        .log-success { color: #28a745; }
        .log-error { color: #dc3545; }
        .log-warning { color: #ffc107; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª Unit Selection State Test</h1>
        
        <div class="test-section">
            <h2 class="test-title">ğŸ¯ å•ä½é€‰æ‹©çŠ¶æ€æµ‹è¯•</h2>
            <p>æµ‹è¯•å•ä½é€‰æ‹©æ—¶çš„äº‹ä»¶è§¦å‘ã€çŠ¶æ€æ›´æ–°å’Œç»„ä»¶é—´æ•°æ®ä¼ é€’</p>
            
            <div class="state-display">
                <h3>ğŸ“Š å½“å‰çŠ¶æ€</h3>
                <div class="state-item">
                    <strong>UnitSelector çŠ¶æ€:</strong> <span id="unitSelectorState">æœªåˆå§‹åŒ–</span>
                </div>
                <div class="state-item">
                    <strong>EvolutionPage çŠ¶æ€:</strong> <span id="evolutionPageState">æœªåˆå§‹åŒ–</span>
                </div>
                <div class="state-item">
                    <strong>MaterialsList çŠ¶æ€:</strong> <span id="materialsListState">æœªåˆå§‹åŒ–</span>
                </div>
                <div class="state-item">
                    <strong>CostSummary çŠ¶æ€:</strong> <span id="costSummaryState">æœªåˆå§‹åŒ–</span>
                </div>
                <div class="state-item">
                    <strong>FarmingGuide çŠ¶æ€:</strong> <span id="farmingGuideState">æœªåˆå§‹åŒ–</span>
                </div>
            </div>
            
            <div class="test-section">
                <h3>ğŸ® æµ‹è¯•æ“ä½œ</h3>
                <button class="test-button" onclick="testUnitSelection()">æµ‹è¯•å•ä½é€‰æ‹©</button>
                <button class="test-button" onclick="testComponentCommunication()">æµ‹è¯•ç»„ä»¶é€šä¿¡</button>
                <button class="test-button" onclick="testStatePersistence()">æµ‹è¯•çŠ¶æ€æŒä¹…æ€§</button>
                <button class="test-button" onclick="clearTestLog()">æ¸…é™¤æ—¥å¿—</button>
            </div>
        </div>
        
        <div class="test-section">
            <h2 class="test-title">ğŸ“ è°ƒè¯•æ—¥å¿—</h2>
            <div id="testLog" class="log-section">
                <div class="log-entry log-info">ç­‰å¾…æµ‹è¯•å¼€å§‹...</div>
            </div>
        </div>
        
        <div class="test-section">
            <h2 class="test-title">ğŸ” å®æ—¶ç›‘æ§</h2>
            <div id="realTimeMonitor" class="state-display">
                <h3>ğŸ”„ å®æ—¶çŠ¶æ€ç›‘æ§</h3>
                <div id="monitorContent">
                    <p>ç­‰å¾…ç»„ä»¶åˆå§‹åŒ–...</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { EVOLUTION_UNITS } from './js/config/evolutionUnits.js';
        import { RARITIES, ELEMENTS, dataUtils } from './js/config/constants.js';
        import { UnitSelector } from './js/components/UnitSelector.js';
        import { MaterialsList } from './js/components/MaterialsList.js';
        import { CostSummary } from './js/components/CostSummary.js';
        import { FarmingGuide } from './js/components/FarmingGuide.js';

        // æµ‹è¯•çŠ¶æ€ç®¡ç†
        let testComponents = {
            unitSelector: null,
            materialsList: null,
            costSummary: null,
            farmingGuide: null
        };

        let testLog = [];

        // æ·»åŠ æ—¥å¿—
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = {
                timestamp,
                message,
                type
            };
            testLog.push(logEntry);
            
            const logDiv = document.getElementById('testLog');
            const logElement = document.createElement('div');
            logElement.className = `log-entry log-${type}`;
            logElement.innerHTML = `[${timestamp}] ${message}`;
            logDiv.appendChild(logElement);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStateDisplay() {
            document.getElementById('unitSelectorState').textContent = 
                testComponents.unitSelector ? 'å·²åˆå§‹åŒ–' : 'æœªåˆå§‹åŒ–';
            document.getElementById('materialsListState').textContent = 
                testComponents.materialsList ? 'å·²åˆå§‹åŒ–' : 'æœªåˆå§‹åŒ–';
            document.getElementById('costSummaryState').textContent = 
                testComponents.costSummary ? 'å·²åˆå§‹åŒ–' : 'æœªåˆå§‹åŒ–';
            document.getElementById('farmingGuideState').textContent = 
                testComponents.farmingGuide ? 'å·²åˆå§‹åŒ–' : 'æœªåˆå§‹åŒ–';
        }

        // æ›´æ–°å®æ—¶ç›‘æ§
        function updateRealTimeMonitor() {
            const monitorContent = document.getElementById('monitorContent');
            let content = '';
            
            if (testComponents.unitSelector) {
                const currentUnit = testComponents.unitSelector.getCurrentUnit();
                content += `<p><strong>UnitSelector:</strong> ${currentUnit ? currentUnit.name : 'æ— é€‰æ‹©'}</p>`;
            }
            
            if (testComponents.materialsList) {
                content += `<p><strong>MaterialsList:</strong> ${testComponents.materialsList.currentUnit ? testComponents.materialsList.currentUnit.name : 'æ— å•ä½'}</p>`;
            }
            
            if (testComponents.costSummary) {
                content += `<p><strong>CostSummary:</strong> ${testComponents.costSummary.currentUnit ? testComponents.costSummary.currentUnit.name : 'æ— å•ä½'}</p>`;
            }
            
            if (testComponents.farmingGuide) {
                content += `<p><strong>FarmingGuide:</strong> ${testComponents.farmingGuide.currentUnit ? testComponents.farmingGuide.currentUnit.name : 'æ— å•ä½'}</p>`;
            }
            
            monitorContent.innerHTML = content || '<p>ç»„ä»¶æœªåˆå§‹åŒ–</p>';
        }

        // åˆå§‹åŒ–æµ‹è¯•ç»„ä»¶
        function initializeTestComponents() {
            addLog('ğŸš€ å¼€å§‹åˆå§‹åŒ–æµ‹è¯•ç»„ä»¶...', 'info');
            
            try {
                // åˆ›å»ºæµ‹è¯•å®¹å™¨
                const testContainer = document.createElement('div');
                testContainer.id = 'testContainer';
                testContainer.style.display = 'none';
                document.body.appendChild(testContainer);
                
                // åˆå§‹åŒ– UnitSelector
                testComponents.unitSelector = new UnitSelector('testContainer', {
                    onUnitSelect: (unit) => {
                        addLog(`ğŸ“ UnitSelector å›è°ƒè§¦å‘: ${unit.name}`, 'success');
                        
                        // æ¨¡æ‹Ÿ EvolutionPage çš„å¤„ç†
                        if (testComponents.materialsList) {
                            testComponents.materialsList.updateMaterials(unit);
                            addLog(`ğŸ“‹ MaterialsList å·²æ›´æ–°: ${unit.name}`, 'success');
                        }
                        
                        if (testComponents.costSummary) {
                            testComponents.costSummary.updateCost(unit);
                            addLog(`ğŸ’° CostSummary å·²æ›´æ–°: ${unit.name}`, 'success');
                        }
                        
                        if (testComponents.farmingGuide) {
                            testComponents.farmingGuide.updateGuide(unit);
                            addLog(`ğŸŒ¾ FarmingGuide å·²æ›´æ–°: ${unit.name}`, 'success');
                        }
                        
                        updateRealTimeMonitor();
                    }
                });
                
                // åˆå§‹åŒ–å…¶ä»–ç»„ä»¶
                testComponents.materialsList = new MaterialsList('testContainer');
                testComponents.costSummary = new CostSummary('testContainer');
                testComponents.farmingGuide = new FarmingGuide('testContainer');
                
                // è®¾ç½®æµ‹è¯•æ•°æ®
                testComponents.unitSelector.setUnits(EVOLUTION_UNITS, {});
                testComponents.materialsList.setMaterialsConfig({});
                testComponents.costSummary.setMaterialsConfig({});
                
                updateStateDisplay();
                updateRealTimeMonitor();
                
                addLog('âœ… æ‰€æœ‰æµ‹è¯•ç»„ä»¶åˆå§‹åŒ–å®Œæˆ', 'success');
                
            } catch (error) {
                addLog(`âŒ ç»„ä»¶åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•å•ä½é€‰æ‹©
        window.testUnitSelection = function() {
            addLog('ğŸ¯ å¼€å§‹æµ‹è¯•å•ä½é€‰æ‹©...', 'info');
            
            if (!testComponents.unitSelector) {
                addLog('âŒ UnitSelector æœªåˆå§‹åŒ–', 'error');
                return;
            }
            
            // é€‰æ‹©ä¸€ä¸ªæµ‹è¯•å•ä½
            const testUnit = EVOLUTION_UNITS[0]; // é€‰æ‹©ç¬¬ä¸€ä¸ªå•ä½
            addLog(`ğŸ¯ é€‰æ‹©æµ‹è¯•å•ä½: ${testUnit.name}`, 'info');
            
            // æ¨¡æ‹Ÿé€‰æ‹©äº‹ä»¶
            testComponents.unitSelector.selectUnit(testUnit);
            
            addLog('âœ… å•ä½é€‰æ‹©æµ‹è¯•å®Œæˆ', 'success');
        };

        // æµ‹è¯•ç»„ä»¶é€šä¿¡
        window.testComponentCommunication = function() {
            addLog('ğŸ”„ å¼€å§‹æµ‹è¯•ç»„ä»¶é€šä¿¡...', 'info');
            
            if (!testComponents.unitSelector) {
                addLog('âŒ ç»„ä»¶æœªåˆå§‹åŒ–', 'error');
                return;
            }
            
            // æµ‹è¯•å¤šä¸ªå•ä½é€‰æ‹©
            const testUnits = EVOLUTION_UNITS.slice(0, 3);
            
            testUnits.forEach((unit, index) => {
                setTimeout(() => {
                    addLog(`ğŸ”„ æµ‹è¯•é€šä¿¡ ${index + 1}: ${unit.name}`, 'info');
                    testComponents.unitSelector.selectUnit(unit);
                }, index * 1000);
            });
            
            addLog('âœ… ç»„ä»¶é€šä¿¡æµ‹è¯•å®Œæˆ', 'success');
        };

        // æµ‹è¯•çŠ¶æ€æŒä¹…æ€§
        window.testStatePersistence = function() {
            addLog('ğŸ’¾ å¼€å§‹æµ‹è¯•çŠ¶æ€æŒä¹…æ€§...', 'info');
            
            if (!testComponents.unitSelector) {
                addLog('âŒ ç»„ä»¶æœªåˆå§‹åŒ–', 'error');
                return;
            }
            
            const testUnit = EVOLUTION_UNITS[1];
            addLog(`ğŸ’¾ è®¾ç½®æµ‹è¯•çŠ¶æ€: ${testUnit.name}`, 'info');
            
            testComponents.unitSelector.selectUnit(testUnit);
            
            // éªŒè¯çŠ¶æ€æ˜¯å¦ä¿æŒ
            setTimeout(() => {
                const currentUnit = testComponents.unitSelector.getCurrentUnit();
                if (currentUnit && currentUnit.id === testUnit.id) {
                    addLog('âœ… çŠ¶æ€æŒä¹…æ€§æµ‹è¯•é€šè¿‡', 'success');
                } else {
                    addLog('âŒ çŠ¶æ€æŒä¹…æ€§æµ‹è¯•å¤±è´¥', 'error');
                }
            }, 500);
        };

        // æ¸…é™¤æµ‹è¯•æ—¥å¿—
        window.clearTestLog = function() {
            document.getElementById('testLog').innerHTML = '<div class="log-entry log-info">æ—¥å¿—å·²æ¸…é™¤</div>';
            testLog = [];
        };

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', function() {
            addLog('ğŸš€ å•ä½é€‰æ‹©çŠ¶æ€æµ‹è¯•é¡µé¢å·²åŠ è½½', 'info');
            addLog(`ğŸ“Š åŠ è½½äº† ${EVOLUTION_UNITS.length} ä¸ªè¿›åŒ–å•ä½`, 'info');
            
            // å»¶è¿Ÿåˆå§‹åŒ–ç»„ä»¶
            setTimeout(() => {
                initializeTestComponents();
            }, 1000);
        });
    </script>
</body>
</html> 