<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unit Selection State Test</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components/forms.css">
    <link rel="stylesheet" href="css/pages/evolution.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #0f0f23;
            color: #ffffff;
        }
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            background: #1a1a2e;
            padding: 20px;
            border-radius: 8px;
        }
        .test-section { 
            margin: 20px 0; 
            padding: 15px; 
            border: 1px solid #333; 
            border-radius: 5px; 
        }
        .test-title {
            color: #6c5ce7;
            margin-bottom: 15px;
        }
        .state-display {
            background: #2a2a3e;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #444;
        }
        .state-item {
            margin: 5px 0;
            padding: 5px;
            background: rgba(108, 92, 231, 0.1);
            border-radius: 3px;
        }
        .test-button {
            background: #6c5ce7;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #5a4fd8;
        }
        .log-section {
            background: #2a2a3e;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        .log-entry {
            margin: 2px 0;
            padding: 2px;
            font-family: monospace;
            font-size: 0.9rem;
        }
        .log-info { color: #6c5ce7; }
        .log-success { color: #28a745; }
        .log-error { color: #dc3545; }
        .log-warning { color: #ffc107; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 Unit Selection State Test</h1>
        
        <div class="test-section">
            <h2 class="test-title">🎯 单位选择状态测试</h2>
            <p>测试单位选择时的事件触发、状态更新和组件间数据传递</p>
            
            <div class="state-display">
                <h3>📊 当前状态</h3>
                <div class="state-item">
                    <strong>UnitSelector 状态:</strong> <span id="unitSelectorState">未初始化</span>
                </div>
                <div class="state-item">
                    <strong>EvolutionPage 状态:</strong> <span id="evolutionPageState">未初始化</span>
                </div>
                <div class="state-item">
                    <strong>MaterialsList 状态:</strong> <span id="materialsListState">未初始化</span>
                </div>
                <div class="state-item">
                    <strong>CostSummary 状态:</strong> <span id="costSummaryState">未初始化</span>
                </div>
                <div class="state-item">
                    <strong>FarmingGuide 状态:</strong> <span id="farmingGuideState">未初始化</span>
                </div>
            </div>
            
            <div class="test-section">
                <h3>🎮 测试操作</h3>
                <button class="test-button" onclick="testUnitSelection()">测试单位选择</button>
                <button class="test-button" onclick="testComponentCommunication()">测试组件通信</button>
                <button class="test-button" onclick="testStatePersistence()">测试状态持久性</button>
                <button class="test-button" onclick="clearTestLog()">清除日志</button>
            </div>
        </div>
        
        <div class="test-section">
            <h2 class="test-title">📝 调试日志</h2>
            <div id="testLog" class="log-section">
                <div class="log-entry log-info">等待测试开始...</div>
            </div>
        </div>
        
        <div class="test-section">
            <h2 class="test-title">🔍 实时监控</h2>
            <div id="realTimeMonitor" class="state-display">
                <h3>🔄 实时状态监控</h3>
                <div id="monitorContent">
                    <p>等待组件初始化...</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { EVOLUTION_UNITS } from './js/config/evolutionUnits.js';
        import { RARITIES, ELEMENTS, dataUtils } from './js/config/constants.js';
        import { UnitSelector } from './js/components/UnitSelector.js';
        import { MaterialsList } from './js/components/MaterialsList.js';
        import { CostSummary } from './js/components/CostSummary.js';
        import { FarmingGuide } from './js/components/FarmingGuide.js';

        // 测试状态管理
        let testComponents = {
            unitSelector: null,
            materialsList: null,
            costSummary: null,
            farmingGuide: null
        };

        let testLog = [];

        // 添加日志
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = {
                timestamp,
                message,
                type
            };
            testLog.push(logEntry);
            
            const logDiv = document.getElementById('testLog');
            const logElement = document.createElement('div');
            logElement.className = `log-entry log-${type}`;
            logElement.innerHTML = `[${timestamp}] ${message}`;
            logDiv.appendChild(logElement);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // 更新状态显示
        function updateStateDisplay() {
            document.getElementById('unitSelectorState').textContent = 
                testComponents.unitSelector ? '已初始化' : '未初始化';
            document.getElementById('materialsListState').textContent = 
                testComponents.materialsList ? '已初始化' : '未初始化';
            document.getElementById('costSummaryState').textContent = 
                testComponents.costSummary ? '已初始化' : '未初始化';
            document.getElementById('farmingGuideState').textContent = 
                testComponents.farmingGuide ? '已初始化' : '未初始化';
        }

        // 更新实时监控
        function updateRealTimeMonitor() {
            const monitorContent = document.getElementById('monitorContent');
            let content = '';
            
            if (testComponents.unitSelector) {
                const currentUnit = testComponents.unitSelector.getCurrentUnit();
                content += `<p><strong>UnitSelector:</strong> ${currentUnit ? currentUnit.name : '无选择'}</p>`;
            }
            
            if (testComponents.materialsList) {
                content += `<p><strong>MaterialsList:</strong> ${testComponents.materialsList.currentUnit ? testComponents.materialsList.currentUnit.name : '无单位'}</p>`;
            }
            
            if (testComponents.costSummary) {
                content += `<p><strong>CostSummary:</strong> ${testComponents.costSummary.currentUnit ? testComponents.costSummary.currentUnit.name : '无单位'}</p>`;
            }
            
            if (testComponents.farmingGuide) {
                content += `<p><strong>FarmingGuide:</strong> ${testComponents.farmingGuide.currentUnit ? testComponents.farmingGuide.currentUnit.name : '无单位'}</p>`;
            }
            
            monitorContent.innerHTML = content || '<p>组件未初始化</p>';
        }

        // 初始化测试组件
        function initializeTestComponents() {
            addLog('🚀 开始初始化测试组件...', 'info');
            
            try {
                // 创建测试容器
                const testContainer = document.createElement('div');
                testContainer.id = 'testContainer';
                testContainer.style.display = 'none';
                document.body.appendChild(testContainer);
                
                // 初始化 UnitSelector
                testComponents.unitSelector = new UnitSelector('testContainer', {
                    onUnitSelect: (unit) => {
                        addLog(`📞 UnitSelector 回调触发: ${unit.name}`, 'success');
                        
                        // 模拟 EvolutionPage 的处理
                        if (testComponents.materialsList) {
                            testComponents.materialsList.updateMaterials(unit);
                            addLog(`📋 MaterialsList 已更新: ${unit.name}`, 'success');
                        }
                        
                        if (testComponents.costSummary) {
                            testComponents.costSummary.updateCost(unit);
                            addLog(`💰 CostSummary 已更新: ${unit.name}`, 'success');
                        }
                        
                        if (testComponents.farmingGuide) {
                            testComponents.farmingGuide.updateGuide(unit);
                            addLog(`🌾 FarmingGuide 已更新: ${unit.name}`, 'success');
                        }
                        
                        updateRealTimeMonitor();
                    }
                });
                
                // 初始化其他组件
                testComponents.materialsList = new MaterialsList('testContainer');
                testComponents.costSummary = new CostSummary('testContainer');
                testComponents.farmingGuide = new FarmingGuide('testContainer');
                
                // 设置测试数据
                testComponents.unitSelector.setUnits(EVOLUTION_UNITS, {});
                testComponents.materialsList.setMaterialsConfig({});
                testComponents.costSummary.setMaterialsConfig({});
                
                updateStateDisplay();
                updateRealTimeMonitor();
                
                addLog('✅ 所有测试组件初始化完成', 'success');
                
            } catch (error) {
                addLog(`❌ 组件初始化失败: ${error.message}`, 'error');
            }
        }

        // 测试单位选择
        window.testUnitSelection = function() {
            addLog('🎯 开始测试单位选择...', 'info');
            
            if (!testComponents.unitSelector) {
                addLog('❌ UnitSelector 未初始化', 'error');
                return;
            }
            
            // 选择一个测试单位
            const testUnit = EVOLUTION_UNITS[0]; // 选择第一个单位
            addLog(`🎯 选择测试单位: ${testUnit.name}`, 'info');
            
            // 模拟选择事件
            testComponents.unitSelector.selectUnit(testUnit);
            
            addLog('✅ 单位选择测试完成', 'success');
        };

        // 测试组件通信
        window.testComponentCommunication = function() {
            addLog('🔄 开始测试组件通信...', 'info');
            
            if (!testComponents.unitSelector) {
                addLog('❌ 组件未初始化', 'error');
                return;
            }
            
            // 测试多个单位选择
            const testUnits = EVOLUTION_UNITS.slice(0, 3);
            
            testUnits.forEach((unit, index) => {
                setTimeout(() => {
                    addLog(`🔄 测试通信 ${index + 1}: ${unit.name}`, 'info');
                    testComponents.unitSelector.selectUnit(unit);
                }, index * 1000);
            });
            
            addLog('✅ 组件通信测试完成', 'success');
        };

        // 测试状态持久性
        window.testStatePersistence = function() {
            addLog('💾 开始测试状态持久性...', 'info');
            
            if (!testComponents.unitSelector) {
                addLog('❌ 组件未初始化', 'error');
                return;
            }
            
            const testUnit = EVOLUTION_UNITS[1];
            addLog(`💾 设置测试状态: ${testUnit.name}`, 'info');
            
            testComponents.unitSelector.selectUnit(testUnit);
            
            // 验证状态是否保持
            setTimeout(() => {
                const currentUnit = testComponents.unitSelector.getCurrentUnit();
                if (currentUnit && currentUnit.id === testUnit.id) {
                    addLog('✅ 状态持久性测试通过', 'success');
                } else {
                    addLog('❌ 状态持久性测试失败', 'error');
                }
            }, 500);
        };

        // 清除测试日志
        window.clearTestLog = function() {
            document.getElementById('testLog').innerHTML = '<div class="log-entry log-info">日志已清除</div>';
            testLog = [];
        };

        // 页面加载时初始化
        window.addEventListener('load', function() {
            addLog('🚀 单位选择状态测试页面已加载', 'info');
            addLog(`📊 加载了 ${EVOLUTION_UNITS.length} 个进化单位`, 'info');
            
            // 延迟初始化组件
            setTimeout(() => {
                initializeTestComponents();
            }, 1000);
        });
    </script>
</body>
</html> 